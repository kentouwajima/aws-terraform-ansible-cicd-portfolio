name: Terraform CI/CD & Ansible

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'README.md'
      - 'LICENSE'
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'README.md'
      - 'LICENSE'
      
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy Infrastructure & App
    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: "ap-northeast-1"
      TF_VAR_db_password: ${{ secrets.TF_VAR_db_password }}
      TF_VAR_alert_email: ${{ secrets.TF_VAR_ALERT_EMAIL }}
      TF_VAR_allowed_ssh_cidr: ${{ secrets.TF_VAR_ALLOWED_SSH_CIDR }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.10.0

      - name: Terraform Init
        run: terraform init

      - name: Terraform Format
        run: terraform fmt -check

      - name: Terraform Validate
        run: terraform validate

      # --- Terraform Apply ---
      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -input=false

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: terraform apply -auto-approve -input=false

      # --- Ansible Execution ---
      
      # 1. IPとSG情報の取得、鍵の生成
      - name: Configure Dynamic IP & Secrets
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        id: config_dynamic_env
        run: |
          MY_IP=$(curl -s http://checkip.amazonaws.com)
          echo "DETECTED_IP=$MY_IP" >> $GITHUB_ENV
          
          # outputs.tf で定義した名前と一致させる必要があります
          echo "EC2_IP=$(terraform output -raw ec2_public_ip)" >> $GITHUB_ENV
          echo "SG_ID=$(terraform output -raw ec2_ssh_sg_id)" >> $GITHUB_ENV
          
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > private_key.pem
          chmod 600 private_key.pem

      # 2. セキュリティグループの一時開放
      - name: Authorize Security Group Ingress
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "Adding IP ${{ env.DETECTED_IP }} to Security Group ${{ env.SG_ID }}"
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ env.SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ env.DETECTED_IP }}/32

      # 3. Ansibleのインストール
      - name: Install Ansible
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: pip install ansible

      # 4. Playbook実行
      - name: Run Ansible Playbook
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: |
          sleep 5
          ansible-playbook -i "${{ env.EC2_IP }}," -u ec2-user --private-key private_key.pem ansible/playbook.yml

      # 5. セキュリティグループを閉じる (必ず実行)
      - name: Revoke Security Group Ingress
        if: always() && github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "Removing IP ${{ env.DETECTED_IP }} from Security Group ${{ env.SG_ID }}"
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ env.SG_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ env.DETECTED_IP }}/32